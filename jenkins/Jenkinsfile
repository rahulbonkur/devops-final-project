pipeline {
  agent any

  /***********************
   * PIPELINE SAFETY
   ***********************/
  options {
    timeout(time: 45, unit: 'MINUTES')
    disableConcurrentBuilds()
    timestamps()
  }

  /***********************
   * PARAMETERS
   ***********************/
  parameters {
    choice(
      name: 'WHAT_TO_DEPLOY',
      choices: ['all', 'recipe', 'chatbot', 'destroy'],
      description: 'Select what you want to deploy'
    )
  }

  /***********************
   * ENV VARIABLES
   ***********************/
  environment {
    AWS_REGION        = 'ap-south-1'
    CODEBUILD_PROJECT = 'ai-chatbot'
    ECS_CLUSTER       = 'ai-chatbot-cluster'
    ECS_SERVICE       = 'ai-chatbot-service'
    TF_INPUT          = "false"   // üöÄ disables ALL terraform prompts
  }

  stages {

    /***********************
     * CHECKOUT
     ***********************/
    stage('Checkout') {
      steps {
        checkout scm
        echo "‚úÖ Code checked out successfully"
      }
    }

    /***********************
     * TERRAFORM DESTROY
     ***********************/
    stage('Terraform Destroy') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'destroy' }
      }
      steps {
        dir('terraform') {
          withCredentials([
            string(credentialsId: 'groq-api-key', variable: 'GROQ_API_KEY'),
            [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
          ]) {
            sh '''
              aws sts get-caller-identity

              terraform init -input=false -upgrade=false
              terraform destroy -auto-approve \
                -var="groq_api_key=$GROQ_API_KEY"
            '''
          }
        }
      }
    }

    /***********************
     * TERRAFORM APPLY
     ***********************/
    stage('Terraform Apply') {
      when {
        expression { params.WHAT_TO_DEPLOY != 'destroy' }
      }
      steps {
        dir('terraform') {
          withCredentials([
            string(credentialsId: 'groq-api-key', variable: 'GROQ_API_KEY'),
            [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
          ]) {
            sh '''
              aws sts get-caller-identity

              terraform init -input=false -upgrade=false
              terraform apply -auto-approve \
                -var="groq_api_key=$GROQ_API_KEY"
            '''
          }
        }
      }
    }

    /***********************
     * CODEBUILD ‚Äì AI CHATBOT
     ***********************/
    stage('Build AI Chatbot (CodeBuild)') {
      when {
        expression {
          params.WHAT_TO_DEPLOY == 'all' ||
          params.WHAT_TO_DEPLOY == 'chatbot'
        }
      }
      steps {
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
        ]) {
          script {
            echo "üöÄ Starting AWS CodeBuild..."

            def buildId = sh(
              script: """
                aws codebuild start-build \
                  --project-name ${CODEBUILD_PROJECT} \
                  --region ${AWS_REGION} \
                  --query 'build.id' \
                  --output text
              """,
              returnStdout: true
            ).trim()

            echo "üß± CodeBuild ID: ${buildId}"

            timeout(time: 20, unit: 'MINUTES') {
              waitUntil {
                def status = sh(
                  script: """
                    aws codebuild batch-get-builds \
                      --ids ${buildId} \
                      --region ${AWS_REGION} \
                      --query 'builds[0].buildStatus' \
                      --output text
                  """,
                  returnStdout: true
                ).trim()

                echo "üîÑ CodeBuild status: ${status}"

                if (status == 'SUCCEEDED') return true
                if (status in ['FAILED', 'STOPPED', 'FAULT']) {
                  error "‚ùå CodeBuild failed with status: ${status}"
                }

                sleep 15
                return false
              }
            }
          }
        }
      }
    }

    /***********************
     * ECS DEPLOY
     ***********************/
    stage('Deploy AI Chatbot to ECS') {
      when {
        expression {
          params.WHAT_TO_DEPLOY == 'all' ||
          params.WHAT_TO_DEPLOY == 'chatbot'
        }
      }
      steps {
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']
        ]) {
          sh '''
            echo "üöÄ Deploying AI Chatbot to ECS"

            aws ecs update-service \
              --cluster ${ECS_CLUSTER} \
              --service ${ECS_SERVICE} \
              --force-new-deployment \
              --region ${AWS_REGION}
          '''
        }
      }
    }

    /***********************
     * ANSIBLE ‚Äì RECIPE APP
     ***********************/
    stage('Deploy Recipe App (Ansible)') {
      when {
        expression {
          params.WHAT_TO_DEPLOY == 'all' ||
          params.WHAT_TO_DEPLOY == 'recipe'
        }
      }
      steps {
        dir('ansible') {
          sh '''
            echo "üöÄ Deploying Recipe App using Ansible"

            ansible-playbook \
              -i inventory/hosts \
              playbooks/deploy-recipe-app.yml
          '''
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ PIPELINE SUCCESS ‚Üí ${params.WHAT_TO_DEPLOY}"
    }
    failure {
      echo "‚ùå PIPELINE FAILED ‚Üí ${params.WHAT_TO_DEPLOY}"
    }
  }
}
