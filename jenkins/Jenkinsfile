pipeline {
  agent any

  environment {
    AWS_REGION = 'ap-south-1'
    CODEBUILD_PROJECT = 'ai-chatbot'
    ECS_CLUSTER = 'ai-chatbot-cluster'
    ECS_SERVICE = 'ai-chatbot-service'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        echo "✅ Code checked out"
      }
    }

    stage('Terraform Apply') {
      steps {
        dir('terraform') {
          sh '''
            terraform init -input=false
            terraform apply -auto-approve
          '''
        }
      }
    }

    stage('Build & Push AI Chatbot Image') {
      steps {
        script {
          def buildId = sh(
            script: """
              aws codebuild start-build \
                --project-name ${CODEBUILD_PROJECT} \
                --region ${AWS_REGION} \
                --query 'build.id' \
                --output text
            """,
            returnStdout: true
          ).trim()

          echo "CodeBuild Build ID: ${buildId}"

          timeout(time: 15, unit: 'MINUTES') {
            waitUntil {
              def buildInfo = sh(
                script: """
                  aws codebuild batch-get-builds \
                    --ids ${buildId} \
                    --region ${AWS_REGION} \
                    --query 'builds[0].[buildStatus,logs.deepLink]' \
                    --output text
                """,
                returnStdout: true
              ).trim()

              def parts = buildInfo.split('\t')
              def status = parts[0]
              def logLink = parts.length > 1 ? parts[1] : "N/A"

              echo "CodeBuild status: ${status}"
              
              if (status == 'SUCCEEDED') {
                echo "✅ CodeBuild succeeded!"
                return true
              }
              
              if (status in ['FAILED','FAULT','STOPPED']) {
                echo "❌ CodeBuild failed with status: ${status}"
                echo "View logs at: ${logLink}"
                
                // Try to get build logs
                sh """
                  echo "Fetching CodeBuild logs..."
                  aws codebuild batch-get-builds \
                    --ids ${buildId} \
                    --region ${AWS_REGION} \
                    --query 'builds[0].[buildStatus,currentPhase,sourceLocation]' \
                    --output text || true
                """
                
                error "CodeBuild failed: ${status}. Check logs at: ${logLink}"
              }

              sleep 15
              return false
            }
          }
        }
      }
    }

    stage('Deploy AI Chatbot to ECS') {
      steps {
        sh '''
          aws ecs update-service \
            --cluster ${ECS_CLUSTER} \
            --service ${ECS_SERVICE} \
            --force-new-deployment \
            --region ${AWS_REGION}
        '''
      }
    }

    stage('Deploy Recipe App (Ansible)') {
      steps {
        dir('ansible') {
          sh '''
            ansible-playbook \
              -i inventory/hosts \
              playbooks/deploy-recipe-app.yml
          '''
        }
      }
    }
  }

  post {
    success { echo "✅ FULL PIPELINE SUCCESSFUL" }
    failure { echo "❌ PIPELINE FAILED – CHECK LOGS" }
  }
}
