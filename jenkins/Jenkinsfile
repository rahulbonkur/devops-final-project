pipeline {
  agent any

  parameters {
    choice(
      name: 'WHAT_TO_DEPLOY',
      choices: ['all', 'recipe', 'chatbot', 'destroy'],
      description: 'Select what you want to deploy'
    )
  }

  environment {
    AWS_REGION      = 'ap-south-1'
    CODEBUILD_PROJECT = 'ai-chatbot'
    ECS_CLUSTER     = 'ai-chatbot-cluster'
    ECS_SERVICE     = 'ai-chatbot-service'
  }

  stages {

    /* =======================
       CHECKOUT
    ======================= */
    stage('Checkout') {
      steps {
        checkout scm
        echo "‚úÖ Code checked out"
      }
    }

    /* =======================
       TERRAFORM DESTROY
    ======================= */
    stage('Terraform Destroy') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'destroy' }
      }
      steps {
        dir('terraform') {
          sh '''
            terraform init -input=false
            terraform destroy -auto-approve
          '''
        }
      }
    }

    /* =======================
       TERRAFORM APPLY
    ======================= */
    stage('Terraform Apply') {
      when {
        expression { params.WHAT_TO_DEPLOY != 'destroy' }
      }
      steps {
        dir('terraform') {
          sh '''
            terraform init -input=false
            terraform apply -auto-approve
          '''
        }
      }
    }

    /* =======================
       BUILD CHATBOT IMAGE
    ======================= */
stage('Build AI Chatbot (CodeBuild)') {
  when {
    expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'chatbot' }
  }
  steps {
    script {
      echo "üöÄ Starting CodeBuild for AI Chatbot..."

      def buildId = sh(
        script: """
          aws codebuild start-build \
            --project-name ${CODEBUILD_PROJECT} \
            --region ${AWS_REGION} \
            --query 'build.id' \
            --output text
        """,
        returnStdout: true
      ).trim()

      echo "üß± CodeBuild ID: ${buildId}"
      echo "‚è≥ Waiting for CodeBuild to finish..."

      sh """
        aws codebuild batch-get-builds \
          --ids ${buildId} \
          --region ${AWS_REGION}
      """

      sh """
        while true; do
          STATUS=\$(aws codebuild batch-get-builds \
            --ids ${buildId} \
            --region ${AWS_REGION} \
            --query 'builds[0].buildStatus' \
            --output text)

          echo "üîÑ CodeBuild status: \$STATUS"

          if [ "\$STATUS" = "SUCCEEDED" ]; then
            echo "‚úÖ CodeBuild succeeded"
            break
          elif [ "\$STATUS" = "FAILED" ] || [ "\$STATUS" = "STOPPED" ]; then
            echo "‚ùå CodeBuild failed"
            exit 1
          fi

          sleep 15
        done
      """
    }
  }
}

stage('Deploy AI Chatbot to ECS') {
  when {
    expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'chatbot' }
  }
  steps {
    echo "üöÄ Deploying AI Chatbot to ECS..."

    sh """
      aws ecs update-service \
        --cluster ${ECS_CLUSTER} \
        --service ${ECS_SERVICE} \
        --force-new-deployment \
        --region ${AWS_REGION}
    """
  }
}

    /* =======================
       DEPLOY CHATBOT TO ECS
    ======================= */
    stage('Deploy AI Chatbot to ECS') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'chatbot' }
      }
      steps {
        sh '''
          echo "‚ôªÔ∏è Forcing ECS redeployment"
          aws ecs update-service \
            --cluster ${ECS_CLUSTER} \
            --service ${ECS_SERVICE} \
            --force-new-deployment \
            --region ${AWS_REGION}
        '''
      }
    }

    /* =======================
       DEPLOY RECIPE APP
    ======================= */
    stage('Deploy Recipe App (Ansible)') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'recipe' }
      }
      steps {
        dir('ansible') {
          sh '''
            ansible-playbook \
              -i inventory/hosts \
              playbooks/deploy-recipe-app.yml
          '''
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ PIPELINE SUCCESS ‚Äì ${params.WHAT_TO_DEPLOY}"
    }
    failure {
      echo "‚ùå PIPELINE FAILED ‚Äì CHECK LOGS"
    }
  }
}
