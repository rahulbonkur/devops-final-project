pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-south-1'
        ANSIBLE_HOST_KEY_CHECKING = 'False'
    }

    parameters {
        choice(
            name: 'DEPLOYMENT_TARGET',
            choices: ['all', 'infrastructure', 'recipe-app'],
            description: 'Select what to deploy'
        )
        booleanParam(
            name: 'DESTROY_INFRASTRUCTURE',
            defaultValue: false,
            description: '⚠️ Destroy ALL Terraform infrastructure'
        )
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "Repository checked out successfully"
            }
        }

        /* =======================
           DESTROY (ISOLATED)
        ======================= */
        stage('Terraform Destroy') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE }
            }
            steps {
                dir('terraform') {
                    input message: '⚠️ CONFIRM: Destroy ALL infrastructure?', ok: 'Destroy'
                    sh 'terraform destroy -auto-approve'
                }
            }
        }

        /* =======================
           TERRAFORM INIT
        ======================= */
        stage('Terraform Init') {
            when {
                expression {
                    !params.DESTROY_INFRASTRUCTURE &&
                    (params.DEPLOYMENT_TARGET == 'all' ||
                     params.DEPLOYMENT_TARGET == 'infrastructure')
                }
            }
            steps {
                dir('terraform') {
                    sh '''
                        terraform init
                        terraform validate
                    '''
                }
            }
        }

        stage('Terraform Plan') {
            when {
                expression {
                    !params.DESTROY_INFRASTRUCTURE &&
                    (params.DEPLOYMENT_TARGET == 'all' ||
                     params.DEPLOYMENT_TARGET == 'infrastructure')
                }
            }
            steps {
                dir('terraform') {
                    sh 'terraform plan -out=tfplan'
                }
            }
        }

        stage('Terraform Apply') {
            when {
                expression {
                    !params.DESTROY_INFRASTRUCTURE &&
                    (params.DEPLOYMENT_TARGET == 'all' ||
                     params.DEPLOYMENT_TARGET == 'infrastructure')
                }
            }
            steps {
                dir('terraform') {
                    sh 'terraform apply -auto-approve tfplan'
                }
            }
        }

        /* =======================
           OUTPUTS
        ======================= */
        stage('Get Infrastructure Outputs') {
            when {
                expression { !params.DESTROY_INFRASTRUCTURE }
            }
            steps {
                dir('terraform') {
                    script {
                        env.RECIPE_SLAVE_IP = sh(
                            script: 'terraform output -raw recipe_slave_public_ip',
                            returnStdout: true
                        ).trim()
                        echo "Recipe Slave IP: ${env.RECIPE_SLAVE_IP}"
                    }
                }
            }
        }

        stage('Wait for Slave VM') {
            when {
                expression {
                    !params.DESTROY_INFRASTRUCTURE &&
                    (params.DEPLOYMENT_TARGET == 'all' ||
                     params.DEPLOYMENT_TARGET == 'recipe-app')
                }
            }
            steps {
                retry(10) {
                    sleep 10
                    sh """
                        ssh -o StrictHostKeyChecking=no -i ~/.ssh/mykey.pem \
                        ec2-user@${env.RECIPE_SLAVE_IP} 'echo VM ready'
                    """
                }
            }
        }

        stage('Deploy Recipe App with Ansible') {
            when {
                expression {
                    !params.DESTROY_INFRASTRUCTURE &&
                    (params.DEPLOYMENT_TARGET == 'all' ||
                     params.DEPLOYMENT_TARGET == 'recipe-app')
                }
            }
            steps {
                dir('ansible') {
                    sh """
                        cat > inventory/hosts << EOF
[recipe_slave]
${env.RECIPE_SLAVE_IP} ansible_user=ec2-user ansible_ssh_private_key_file=~/.ssh/mykey.pem
EOF
                    """

                    sh '''
                        ansible-playbook -i inventory/hosts \
                        playbooks/deploy-recipe-app.yml -v
                    '''
                }
            }
        }

        stage('Verify Deployment') {
            when {
                expression {
                    !params.DESTROY_INFRASTRUCTURE &&
                    (params.DEPLOYMENT_TARGET == 'all' ||
                     params.DEPLOYMENT_TARGET == 'recipe-app')
                }
            }
            steps {
                retry(3) {
                    sleep 5
                    sh "curl -f http://${env.RECIPE_SLAVE_IP}/health"
                }
            }
        }
    }

    post {
        success {
            echo """
            ✅ DEPLOYMENT SUCCESSFUL
            Target: ${params.DEPLOYMENT_TARGET}
            Recipe App: http://${env.RECIPE_SLAVE_IP}
            """
        }

        failure {
            echo "❌ Deployment failed. Check logs."
        }
    }
}
