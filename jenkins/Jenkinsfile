pipeline {
  agent any

  environment {
    AWS_REGION = 'ap-south-1'
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Terraform Apply') {
      steps {
        dir('terraform') {
          sh '''
            terraform init
            terraform apply -auto-approve
          '''
        }
      }
    }

    stage('Build & Push AI Chatbot Image') {
      steps {
        sh '''
          aws codebuild start-build \
            --project-name ai-chatbot \
            --region ap-south-1
        '''
      }
    }

    stage('Deploy Recipe App') {
      steps {
        dir('ansible') {
          sh '''
            ansible-playbook -i inventory/hosts playbooks/deploy-recipe-app.yml
          '''
        }
      }
    }
  }
}
