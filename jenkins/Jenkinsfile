pipeline {
  agent any

  parameters {
    choice(
      name: 'WHAT_TO_DEPLOY',
      choices: ['all', 'recipe', 'chatbot', 'destroy'],
      description: 'Select what you want to deploy'
    )
  }

  environment {
    AWS_REGION = 'ap-south-1'
    CODEBUILD_PROJECT = 'ai-chatbot'
    ECS_CLUSTER = 'ai-chatbot-cluster'
    ECS_SERVICE = 'ai-chatbot-service'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        echo "✅ Code checked out"
      }
    }

    /* =========================
       TERRAFORM
    ========================= */
    stage('Terraform Apply') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'recipe' || params.WHAT_TO_DEPLOY == 'chatbot' }
      }
      steps {
        dir('terraform') {
          sh '''
            terraform init
            terraform apply -auto-approve
          '''
        }
      }
    }

    stage('Terraform Destroy') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'destroy' }
      }
      steps {
        dir('terraform') {
          sh '''
            terraform init
            terraform destroy -auto-approve
          '''
        }
      }
    }

    /* =========================
       BUILD CHATBOT IMAGE
    ========================= */
    stage('Build AI Chatbot (CodeBuild)') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'chatbot' }
      }
      steps {
        sh '''
          aws codebuild start-build \
            --project-name ${CODEBUILD_PROJECT} \
            --region ${AWS_REGION}
        '''
      }
    }

    /* =========================
       DEPLOY CHATBOT TO ECS
    ========================= */
    stage('Deploy AI Chatbot to ECS') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'chatbot' }
      }
      steps {
        sh '''
          aws ecs update-service \
            --cluster ${ECS_CLUSTER} \
            --service ${ECS_SERVICE} \
            --force-new-deployment \
            --region ${AWS_REGION}
        '''
      }
    }

    /* =========================
       DEPLOY RECIPE APP
    ========================= */
    stage('Deploy Recipe App (Ansible)') {
      when {
        expression { params.WHAT_TO_DEPLOY == 'all' || params.WHAT_TO_DEPLOY == 'recipe' }
      }
      steps {
        dir('ansible') {
          sh '''
            ansible-playbook \
              -i inventory/hosts \
              playbooks/deploy-recipe-app.yml
          '''
        }
      }
    }
  }

  post {
    success {
      echo "✅ Deployment completed for: ${params.WHAT_TO_DEPLOY}"
    }
    failure {
      echo "❌ Deployment failed"
    }
  }
}
